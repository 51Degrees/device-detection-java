<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>51Degrees Device Detection Java: PerformanceBenchmark.java</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="examplegrabber.js"></script>
<script type="text/javascript" src="testedversionsgrabber.js"></script>
<script type="text/javascript" src="search51.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="docs-main.min.css" rel="stylesheet" type="text/css" />
</head>
<body class="l-docs-index p-doxygen">
<div class="l-index__content">
<!--div id="top"--><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea" class="g-header g-header--docs">
  <h1 class="c-brand">
  <a id="projectlogo" href="../../documentation/4.4/index.html" class="c-brand__link"><img class="c-brand__image" alt="Logo" src="logo-51Degrees-Docs.png" style="width:172px;"/></a>
  <span class="c-tagline">51Degrees Device Detection Java
   &#160;<span id="projectnumber">4.4</span>
  </span>
  </h1>
  <div id="projectalign" style="padding-left: 0.5em;">
   <div id="projectbrief">Device detection services for 51Degrees Pipeline</div>
  </div>
  <div id="main-nav"></div>
  <section class="g-search">
    <div class="c-search is-openable" id="searchOpenable">
    <form class="c-search__form">
      <div class="b-form-group b-form-group--with-icon">
        <label for="inputSearch" class="b-text--hidden">Search</label>
        <img src="icon-search.svg" class="b-icon" alt="Search" />
        <input type="text" class="c-search__input" id="inputSearch" onkeyup="javascript:onSearch(this,event.keyCode)" placeholder="Search" aria-label="Search">
      </div>
    </form>
    <div class="c-search__content" id="searchContent">
    </div>
  </div> 
  </section>
</div>
<!-- end header part -->
<main class="g-main">
<!-- Generated by Doxygen 1.8.15 -->
<!-- top -->
	<div class="g-docs__sidenav">																														         <nav id="nav-tree-contents" class="c-sidenav">																														     <h4 class="c-sidenav__heading">Documentation</h4>																									         <div id="nav-sync" class="sync"></div>
  <ul class="c-sidenav__list">																														     </ul>																																				   </nav>    </div><script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_performance_benchmark_8java-example.html','');});
/* @license-end */
</script>
<div id="doc-content" class="g-docs__content">
<div class="g-docs__header">
<h2 class="g-docs__page-title">PerformanceBenchmark.java</h2></div><!--header-->
<div class="g-docs__inner">
<div class="g-docs__primary" id="primary">
<p>The example illustrates a "clock-time" benchmark for assessing detection speed.</p>
<p>Using a YAML formatted evidence file - "20000 Evidence Records.yml" - supplied with the distribution or can be obtained from the (data repository on Github)[<a href="https://github.com/51Degrees/device-detection-data/blob/master/20000%20Evidence%20Records.yml">https://github.com/51Degrees/device-detection-data/blob/master/20000%20Evidence%20Records.yml</a>].</p>
<p>It's important to understand the trade-offs between performance, memory usage and accuracy, that the 51Degrees pipeline configuration makes available, and this example shows a range of different configurations to illustrate the difference in performance.</p>
<p>Requesting properties from a single component reduces detection time compared with requesting properties from multiple components. If you don't specify any properties to detect, then all properties are detected.</p>
<p>Please review (performance options)[<a href="https://51degrees.com/documentation/_device_detection__features__performance_options.html">https://51degrees.com/documentation/_device_detection__features__performance_options.html</a>] and (hash dataset options)[<a href="https://51degrees.com/documentation/_device_detection__hash.html#DeviceDetection_Hash_DataSetProduction_Performance">https://51degrees.com/documentation/_device_detection__hash.html#DeviceDetection_Hash_DataSetProduction_Performance</a>] for more information about adjusting performance.</p>
<p>This example is available in full on <a href="https://github.com/51Degrees/device-detection-java/blob/master/device-detection-java-examples/console/src/main/java/fiftyone/devicedetection/examples/console/PerformanceBenchmark.java">GitHub</a>.</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line"><span class="c-code__comment">/* *********************************************************************</span></div><div class="c-code__line"><span class="c-code__comment"> * This Original Work is copyright of 51 Degrees Mobile Experts Limited.</span></div><div class="c-code__line"><span class="c-code__comment"> * Copyright 2023 51 Degrees Mobile Experts Limited, Davidson House,</span></div><div class="c-code__line"><span class="c-code__comment"> * Forbury Square, Reading, Berkshire, United Kingdom RG1 3EU.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * This Original Work is licensed under the European Union Public Licence</span></div><div class="c-code__line"><span class="c-code__comment"> * (EUPL) v.1.2 and is subject to its terms as set out below.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * If a copy of the EUPL was not distributed with this file, You can obtain</span></div><div class="c-code__line"><span class="c-code__comment"> * one at https://opensource.org/licenses/EUPL-1.2.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * The &#39;Compatible Licences&#39; set out in the Appendix to the EUPL (as may be</span></div><div class="c-code__line"><span class="c-code__comment"> * amended by the European Commission) shall be deemed incompatible for</span></div><div class="c-code__line"><span class="c-code__comment"> * the purposes of the Work and the provisions of the compatibility</span></div><div class="c-code__line"><span class="c-code__comment"> * clause in Article 5 of the EUPL shall not apply.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * If using the Work as, or as part of, a network application, by</span></div><div class="c-code__line"><span class="c-code__comment"> * including the attribution notice(s) required under Article 5 of the EUPL</span></div><div class="c-code__line"><span class="c-code__comment"> * in the end user terms of the application under an appropriate heading,</span></div><div class="c-code__line"><span class="c-code__comment"> * such notice(s) shall fulfill the requirements of that article.</span></div><div class="c-code__line"><span class="c-code__comment"> * ********************************************************************* */</span></div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">package </span>fiftyone.devicedetection.examples.console;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">import</span> fiftyone.common.testhelpers.LogbackHelper;</div><div class="c-code__line"><span class="c-code__keyword">import</span> fiftyone.devicedetection.DeviceDetectionOnPremisePipelineBuilder;</div><div class="c-code__line"><span class="c-code__keyword">import</span> fiftyone.devicedetection.DeviceDetectionPipelineBuilder;</div><div class="c-code__line"><span class="c-code__keyword">import</span> fiftyone.devicedetection.examples.shared.DataFileHelper;</div><div class="c-code__line"><span class="c-code__keyword">import</span> fiftyone.devicedetection.examples.shared.EvidenceHelper;</div><div class="c-code__line"><span class="c-code__keyword">import</span> fiftyone.devicedetection.hash.engine.onpremise.flowelements.DeviceDetectionHashEngine;</div><div class="c-code__line"><span class="c-code__keyword">import</span> fiftyone.devicedetection.shared.DeviceData;</div><div class="c-code__line"><span class="c-code__keyword">import</span> fiftyone.pipeline.core.data.FlowData;</div><div class="c-code__line"><span class="c-code__keyword">import</span> fiftyone.pipeline.core.flowelements.Pipeline;</div><div class="c-code__line"><span class="c-code__keyword">import</span> fiftyone.pipeline.engines.Constants;</div><div class="c-code__line"><span class="c-code__keyword">import</span> fiftyone.pipeline.util.FileFinder;</div><div class="c-code__line"><span class="c-code__keyword">import</span> org.apache.commons.lang3.BooleanUtils;</div><div class="c-code__line"><span class="c-code__keyword">import</span> org.slf4j.Logger;</div><div class="c-code__line"><span class="c-code__keyword">import</span> org.slf4j.LoggerFactory;</div><div class="c-code__line"><span class="c-code__keyword">import</span> org.slf4j.MarkerFactory;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">import</span> java.io.File;</div><div class="c-code__line"><span class="c-code__keyword">import</span> java.io.PrintWriter;</div><div class="c-code__line"><span class="c-code__keyword">import</span> java.nio.file.Files;</div><div class="c-code__line"><span class="c-code__keyword">import</span> java.util.*;</div><div class="c-code__line"><span class="c-code__keyword">import</span> java.util.concurrent.*;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">import</span> <span class="c-code__keyword">static</span> fiftyone.devicedetection.examples.shared.DataFileHelper.getDataFileLocation;</div><div class="c-code__line"><span class="c-code__keyword">import</span> <span class="c-code__keyword">static</span> fiftyone.devicedetection.examples.shared.DataFileHelper.getEvidenceFile;</div><div class="c-code__line"><span class="c-code__keyword">import</span> <span class="c-code__keyword">static</span> fiftyone.pipeline.engines.Constants.PerformanceProfiles.*;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">public</span> <span class="c-code__keyword">class </span>PerformanceBenchmark {</div><div class="c-code__line">    <span class="c-code__comment">// the default number of threads if one is not provided.</span></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> <span class="c-code__keyword">final</span> <span class="c-code__keywordtype">int</span> DEFAULT_NUMBER_OF_THREADS = 4;</div><div class="c-code__line">    <span class="c-code__comment">// the number of tests to execute.</span></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> <span class="c-code__keyword">final</span> <span class="c-code__keywordtype">int</span> TESTS_PER_THREAD = 10000;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> <span class="c-code__keyword">final</span> Logger logger = LoggerFactory.getLogger(PerformanceBenchmark.class);</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// where the results of the tests are gathered</span></div><div class="c-code__line">    <span class="c-code__keyword">private</span> List&lt;Future&lt;BenchmarkResult&gt;&gt; resultList;</div><div class="c-code__line">    <span class="c-code__keyword">private</span> <span class="c-code__keywordtype">int</span> numberOfThreads = DEFAULT_NUMBER_OF_THREADS;</div><div class="c-code__line">    <span class="c-code__keyword">private</span> List&lt;Map&lt;String, String&gt;&gt; evidence;</div><div class="c-code__line">    <span class="c-code__keyword">private</span> String dataFileLocation;</div><div class="c-code__line">    <span class="c-code__keyword">private</span> PrintWriter writer;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// a default set of configurations: (profile, allProperties, performanceGraph, predictiveGraph)</span></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> PerformanceConfiguration [] DEFAULT_PERFORMANCE_CONFIGURATIONS = {</div><div class="c-code__line">            <span class="c-code__keyword">new</span> PerformanceConfiguration(MaxPerformance, <span class="c-code__keyword">false</span>, <span class="c-code__keyword">false</span>, <span class="c-code__keyword">true</span>),</div><div class="c-code__line">            <span class="c-code__keyword">new</span> PerformanceConfiguration(MaxPerformance, <span class="c-code__keyword">false</span>, <span class="c-code__keyword">true</span>, <span class="c-code__keyword">false</span>),</div><div class="c-code__line">            <span class="c-code__keyword">new</span> PerformanceConfiguration(MaxPerformance, <span class="c-code__keyword">true</span>, <span class="c-code__keyword">true</span>, <span class="c-code__keyword">false</span>)</div><div class="c-code__line">    };</div><div class="c-code__line"></div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> <span class="c-code__keywordtype">void</span> main(String[] args) <span class="c-code__keywordflow">throws</span> Exception {</div><div class="c-code__line">        LogbackHelper.configureLogback(FileFinder.getFilePath(<span class="c-code__stringliteral">&quot;logback.xml&quot;</span>));</div><div class="c-code__line"></div><div class="c-code__line">        String dataFilename = args.length &gt; 0 ? args[0] : <span class="c-code__keyword">null</span>;</div><div class="c-code__line">        String evidenceFilename = args.length &gt; 1 ? args[1] : <span class="c-code__keyword">null</span>;</div><div class="c-code__line">        <span class="c-code__keywordtype">int</span> numberOfThreads = DEFAULT_NUMBER_OF_THREADS;</div><div class="c-code__line">        <span class="c-code__keywordflow">if</span> (args.length &gt; 2) {</div><div class="c-code__line">            numberOfThreads = Integer.parseInt(args[2]);</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">new</span> PerformanceBenchmark().runBenchmarks(DEFAULT_PERFORMANCE_CONFIGURATIONS,</div><div class="c-code__line">                dataFilename,</div><div class="c-code__line">                evidenceFilename,</div><div class="c-code__line">                numberOfThreads,</div><div class="c-code__line">                <span class="c-code__keyword">new</span> PrintWriter(System.out,<span class="c-code__keyword">true</span>));</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">protected</span> <span class="c-code__keywordtype">void</span> <a name="a0"></a><a class="code" href="classfiftyone_1_1devicedetection_1_1examples_1_1console_1_1_performance_benchmark.html#ae3d542b8df722282a50952e8df88ef17">runBenchmarks</a>(PerformanceConfiguration[] performanceConfigurations,</div><div class="c-code__line">                                 String dataFilename,</div><div class="c-code__line">                                 String evidenceFilename,</div><div class="c-code__line">                                 <span class="c-code__keywordtype">int</span> numberOfThreads,</div><div class="c-code__line">                                 PrintWriter writer) <span class="c-code__keywordflow">throws</span> Exception {</div><div class="c-code__line"></div><div class="c-code__line">        logger.info(<span class="c-code__stringliteral">&quot;Running Performance example&quot;</span>);</div><div class="c-code__line"></div><div class="c-code__line">        this.dataFileLocation = getDataFileLocation(dataFilename);</div><div class="c-code__line"></div><div class="c-code__line">        File evidenceFile = getEvidenceFile(evidenceFilename);</div><div class="c-code__line">        this.evidence = Collections.unmodifiableList(</div><div class="c-code__line">                EvidenceHelper.getEvidenceList(evidenceFile, 20000));</div><div class="c-code__line">        this.numberOfThreads = numberOfThreads;</div><div class="c-code__line">        this.writer = writer;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// run &quot;from memory&quot; benchmarks - the only profiles that really make sense</span></div><div class="c-code__line">        <span class="c-code__comment">// are maxPerformance</span></div><div class="c-code__line">        <span class="c-code__keywordflow">for</span> (PerformanceConfiguration config: performanceConfigurations){</div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (config.profile.equals(MaxPerformance)) {</div><div class="c-code__line">                executeBenchmark(<span class="c-code__keyword">false</span>, config);</div><div class="c-code__line">            }</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// run the selected benchmarks from disk</span></div><div class="c-code__line">        <span class="c-code__keywordflow">for</span> (PerformanceConfiguration config: performanceConfigurations){</div><div class="c-code__line">            executeBenchmark(<span class="c-code__keyword">true</span>, config);</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        logger.info(<span class="c-code__stringliteral">&quot;Finished Performance example&quot;</span>);</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">private</span> <span class="c-code__keywordtype">void</span> executeBenchmark(<span class="c-code__keywordtype">boolean</span> configureFromDisk,</div><div class="c-code__line">                                  PerformanceConfiguration config) <span class="c-code__keywordflow">throws</span> Exception {</div><div class="c-code__line">        logger.info(MarkerFactory.getMarker(config.profile.name() + <span class="c-code__stringliteral">&quot; &quot;</span> +</div><div class="c-code__line">                        config.allProperties + <span class="c-code__stringliteral">&quot; &quot;</span> +</div><div class="c-code__line">                        config.performanceGraph + <span class="c-code__stringliteral">&quot; &quot;</span> +</div><div class="c-code__line">                        config.predictiveGraph),</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;Benchmarking with profile: {} AllProperties: {}, &quot;</span> +</div><div class="c-code__line">                        <span class="c-code__stringliteral">&quot;performanceGraph: {}, predictiveGraph {}&quot;</span>,</div><div class="c-code__line">                config.profile,</div><div class="c-code__line">                config.allProperties,</div><div class="c-code__line">                config.performanceGraph,</div><div class="c-code__line">                config.predictiveGraph);</div><div class="c-code__line"></div><div class="c-code__line">        Pipeline pipeline = <span class="c-code__keyword">null</span>;</div><div class="c-code__line">        <span class="c-code__keywordflow">try</span> {</div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (configureFromDisk) {</div><div class="c-code__line">                logger.info(<span class="c-code__stringliteral">&quot;Load from disk&quot;</span>);</div><div class="c-code__line">                DeviceDetectionOnPremisePipelineBuilder builder = <span class="c-code__keyword">new</span> DeviceDetectionPipelineBuilder()</div><div class="c-code__line">                        <span class="c-code__comment">// load from disk</span></div><div class="c-code__line">                        .useOnPremise(dataFileLocation, <span class="c-code__keyword">false</span>);</div><div class="c-code__line"></div><div class="c-code__line">                setPipelinePerformanceProperties(builder, config);</div><div class="c-code__line">                pipeline = builder.build();</div><div class="c-code__line"></div><div class="c-code__line">                DataFileHelper.logDataFileInfo(pipeline.getElement(DeviceDetectionHashEngine.class));</div><div class="c-code__line">            } <span class="c-code__keywordflow">else</span> {</div><div class="c-code__line">                logger.info(<span class="c-code__stringliteral">&quot;Load memory from {}&quot;</span>, dataFileLocation);</div><div class="c-code__line">                <span class="c-code__keywordtype">byte</span>[] fileContent = Files.readAllBytes(<span class="c-code__keyword">new</span> File(dataFileLocation).toPath());</div><div class="c-code__line">                logger.info(<span class="c-code__stringliteral">&quot;Memory loaded&quot;</span>);</div><div class="c-code__line"></div><div class="c-code__line">                <span class="c-code__comment">// create a pipeline builder</span></div><div class="c-code__line">                DeviceDetectionOnPremisePipelineBuilder builder = <span class="c-code__keyword">new</span> DeviceDetectionPipelineBuilder()</div><div class="c-code__line">                        <span class="c-code__comment">// load from buffer</span></div><div class="c-code__line">                        .useOnPremise(fileContent);</div><div class="c-code__line"></div><div class="c-code__line">                setPipelinePerformanceProperties(builder, config);</div><div class="c-code__line">                pipeline = builder.build();</div><div class="c-code__line">            }</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// run the benchmarks twice, once to warm up the JVM</span></div><div class="c-code__line">            logger.info(<span class="c-code__stringliteral">&quot;Warming up&quot;</span>);</div><div class="c-code__line">            <span class="c-code__keywordtype">long</span> warmpupTime = runTests(pipeline);</div><div class="c-code__line">            System.gc();</div><div class="c-code__line">            Thread.sleep(300);</div><div class="c-code__line"></div><div class="c-code__line">            logger.info(<span class="c-code__stringliteral">&quot;Running&quot;</span>);</div><div class="c-code__line">            <span class="c-code__keywordtype">long</span> executionTime = runTests(pipeline);</div><div class="c-code__line">            <span class="c-code__keywordtype">long</span> adjustedExecutionTime = executionTime - warmpupTime;</div><div class="c-code__line">            logger.info(<span class="c-code__stringliteral">&quot;Finished - Execution time was {} ms, adjustment from warm-up {} ms&quot;</span>,</div><div class="c-code__line">                    executionTime, adjustedExecutionTime);</div><div class="c-code__line">        } <span class="c-code__keywordflow">finally</span> {</div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (Objects.nonNull(pipeline)) {</div><div class="c-code__line">                pipeline.close();</div><div class="c-code__line">            }</div><div class="c-code__line">        }</div><div class="c-code__line">        doReport();</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">private</span> <span class="c-code__keywordtype">void</span> setPipelinePerformanceProperties(</div><div class="c-code__line">            DeviceDetectionOnPremisePipelineBuilder builder,</div><div class="c-code__line">            PerformanceConfiguration config) {</div><div class="c-code__line">        <span class="c-code__comment">// the different profiles provide for trading off memory usage</span></div><div class="c-code__line">        builder.setPerformanceProfile(config.profile)</div><div class="c-code__line">        <span class="c-code__comment">// set this to false for testing</span></div><div class="c-code__line">        .setAutoUpdate(<span class="c-code__keyword">false</span>)</div><div class="c-code__line">        <span class="c-code__comment">// set this to false for testing</span></div><div class="c-code__line">        .setShareUsage(<span class="c-code__keyword">false</span>)</div><div class="c-code__line">        <span class="c-code__comment">// hint for cache concurrency</span></div><div class="c-code__line">        .setConcurrency(numberOfThreads);</div><div class="c-code__line">        <span class="c-code__comment">// performance is improved by selecting only the properties you intend to use</span></div><div class="c-code__line">        <span class="c-code__comment">// Requesting properties from a single component</span></div><div class="c-code__line">        <span class="c-code__comment">// reduces detection time compared with requesting properties from multiple components.</span></div><div class="c-code__line">        <span class="c-code__comment">// If you don&#39;t specify any properties to detect, then all properties are detected,</span></div><div class="c-code__line">        <span class="c-code__comment">// here we choose &quot;all properties&quot; by specifying none, or just &quot;isMobile&quot;</span></div><div class="c-code__line">        <span class="c-code__keywordflow">if</span> (BooleanUtils.isFalse(config.allProperties)) {</div><div class="c-code__line">            builder.setProperty(<span class="c-code__stringliteral">&quot;isMobile&quot;</span>);</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__comment">// choose performanceGraph or predictiveGraph, choosing both runs uses</span></div><div class="c-code__line">        <span class="c-code__comment">// performance first then predictive, if the result was not found in performance</span></div><div class="c-code__line">        builder.setUsePerformanceGraph(config.performanceGraph);</div><div class="c-code__line">        builder.setUsePredictiveGraph(config.predictiveGraph);</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">private</span> <span class="c-code__keywordtype">void</span> doReport() <span class="c-code__keywordflow">throws</span> Exception {</div><div class="c-code__line">        <span class="c-code__keywordtype">long</span> totalMillis = 0;</div><div class="c-code__line">        <span class="c-code__keywordtype">long</span> totalChecks = 0;</div><div class="c-code__line">        <span class="c-code__keywordtype">int</span> checksum = 0;</div><div class="c-code__line">        <span class="c-code__keywordflow">for</span> (Future&lt;BenchmarkResult&gt; result : resultList) {</div><div class="c-code__line">            BenchmarkResult bmr = result.get();</div><div class="c-code__line"></div><div class="c-code__line">            writer.format(<span class="c-code__stringliteral">&quot;Thread:  %,d detections, elapsed %f seconds, %,d Detections per second%n&quot;</span>,</div><div class="c-code__line">                    bmr.count,</div><div class="c-code__line">                    bmr.elapsedMillis/1000.0,</div><div class="c-code__line">                    (Math.round(1000.0 * bmr.count/ bmr.elapsedMillis)));</div><div class="c-code__line"></div><div class="c-code__line">            totalMillis += bmr.elapsedMillis;</div><div class="c-code__line">            totalChecks += bmr.count;</div><div class="c-code__line">            checksum += bmr.checkSum;</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// output the results from the benchmark to the console</span></div><div class="c-code__line">        <span class="c-code__keywordtype">double</span> millisPerTest = ((double) totalMillis / (numberOfThreads * totalChecks));</div><div class="c-code__line">        writer.format(<span class="c-code__stringliteral">&quot;Overall: %,d detections, Average millisecs per detection: %f, Detections per second: %,d\n&quot;</span>,</div><div class="c-code__line">                totalChecks, millisPerTest, Math.round(1000.0/millisPerTest));</div><div class="c-code__line">        writer.format(<span class="c-code__stringliteral">&quot;Overall: Concurrent threads: %d, Checksum: %x \n&quot;</span>, numberOfThreads, checksum);</div><div class="c-code__line">        writer.println();</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">private</span> <span class="c-code__keywordtype">long</span> runTests(Pipeline pipeline) <span class="c-code__keywordflow">throws</span> Exception {</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// create a list of callables</span></div><div class="c-code__line">        List&lt;Callable&lt;BenchmarkResult&gt;&gt; callables = <span class="c-code__keyword">new</span> ArrayList&lt;&gt;();</div><div class="c-code__line">        <span class="c-code__keywordflow">for</span> (<span class="c-code__keywordtype">int</span> i = 0; i &lt; numberOfThreads; i++) {</div><div class="c-code__line">            callables.add(<span class="c-code__keyword">new</span> BenchmarkRunnable(pipeline, evidence));</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__comment">// start multiple threads in a fixed pool</span></div><div class="c-code__line">        ExecutorService service = Executors.newFixedThreadPool(numberOfThreads);</div><div class="c-code__line">        <span class="c-code__keywordtype">long</span> start = System.currentTimeMillis();</div><div class="c-code__line">        <span class="c-code__comment">// start all the threads</span></div><div class="c-code__line">        resultList = service.invokeAll(callables);</div><div class="c-code__line">        <span class="c-code__comment">// wait for all the threads to complete</span></div><div class="c-code__line">        <span class="c-code__keywordflow">for</span> (Future&lt;BenchmarkResult&gt; result : resultList) {</div><div class="c-code__line">            result.get();</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__keywordtype">long</span> duration = System.currentTimeMillis() - start;</div><div class="c-code__line">        service.shutdown();</div><div class="c-code__line">        <span class="c-code__keywordflow">return</span> duration;</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> <span class="c-code__keyword">class </span>BenchmarkRunnable <span class="c-code__keyword">implements</span> Callable&lt;BenchmarkResult&gt; {</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// the benchmark that is being executed</span></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keyword">final</span> BenchmarkResult result;</div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keyword">final</span> List&lt;Map&lt;String, String&gt;&gt; testList;</div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keyword">final</span> Pipeline pipeline;</div><div class="c-code__line"></div><div class="c-code__line">        BenchmarkRunnable(Pipeline pipeline, List&lt;Map&lt;String, String&gt;&gt; evidence) {</div><div class="c-code__line">            this.testList = evidence;</div><div class="c-code__line">            <span class="c-code__comment">// initialise the benchmark variables</span></div><div class="c-code__line">            this.pipeline = pipeline;</div><div class="c-code__line">            this.result = <span class="c-code__keyword">new</span> BenchmarkResult();</div><div class="c-code__line"></div><div class="c-code__line">            result.elapsedMillis = 0;</div><div class="c-code__line">            result.count = 0;</div><div class="c-code__line">            result.checkSum = 0;</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line"></div><div class="c-code__line">        @Override</div><div class="c-code__line">        <span class="c-code__keyword">public</span> BenchmarkResult call() {</div><div class="c-code__line">            result.checkSum = 0;</div><div class="c-code__line">            <span class="c-code__keywordtype">long</span> start = System.currentTimeMillis();</div><div class="c-code__line">            <span class="c-code__keywordflow">for</span> (Map&lt;String, String&gt; evidence : testList) {</div><div class="c-code__line">                <span class="c-code__comment">// the benchmark is for detection time only</span></div><div class="c-code__line"></div><div class="c-code__line">                <span class="c-code__comment">// A try-with-resource block MUST be used for the</span></div><div class="c-code__line">                <span class="c-code__comment">// FlowData instance. This ensures that native resources</span></div><div class="c-code__line">                <span class="c-code__comment">// created by the device detection engine are freed.</span></div><div class="c-code__line">                <span class="c-code__keywordflow">try</span> (FlowData flowData = pipeline.createFlowData()) {</div><div class="c-code__line">                    flowData</div><div class="c-code__line">                            .addEvidence(evidence)</div><div class="c-code__line">                            .process();</div><div class="c-code__line"></div><div class="c-code__line">                    <span class="c-code__comment">// Calculate a checksum to compare different runs on</span></div><div class="c-code__line">                    <span class="c-code__comment">// the same data.</span></div><div class="c-code__line">                    DeviceData device = flowData.get(DeviceData.class);</div><div class="c-code__line">                    <span class="c-code__keywordflow">if</span> (device != <span class="c-code__keyword">null</span>) {</div><div class="c-code__line">                        <span class="c-code__keywordflow">if</span> (device.getIsMobile().hasValue()) {</div><div class="c-code__line">                            Object value = device.getIsMobile().getValue();</div><div class="c-code__line">                            <span class="c-code__keywordflow">if</span> (value != <span class="c-code__keyword">null</span>) {</div><div class="c-code__line">                                result.checkSum += value.hashCode();</div><div class="c-code__line">                            }</div><div class="c-code__line">                        }</div><div class="c-code__line">                    }</div><div class="c-code__line">                    result.count++;</div><div class="c-code__line">                    <span class="c-code__keywordflow">if</span> (result.count &gt;= TESTS_PER_THREAD) {</div><div class="c-code__line">                        <span class="c-code__keywordflow">break</span>;</div><div class="c-code__line">                    }</div><div class="c-code__line">                } <span class="c-code__keywordflow">catch</span> (Exception e) {</div><div class="c-code__line">                    logger.error(<span class="c-code__stringliteral">&quot;Exception getting flow data&quot;</span>, e);</div><div class="c-code__line">                }</div><div class="c-code__line">            }</div><div class="c-code__line">            result.elapsedMillis += System.currentTimeMillis() - start;</div><div class="c-code__line">            <span class="c-code__keywordflow">return</span> result;</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">static</span> <span class="c-code__keyword">class </span>BenchmarkResult {</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// number of device evidence processed to determine the result.</span></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keywordtype">long</span> count;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// processing time in millis this thread</span></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keywordtype">long</span> elapsedMillis;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// used to ensure compiler optimiser doesn&#39;t optimise out the very</span></div><div class="c-code__line">        <span class="c-code__comment">// method that the benchmark is testing.</span></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keywordtype">int</span> checkSum;</div><div class="c-code__line"></div><div class="c-code__line"></div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> <span class="c-code__keyword">class </span>PerformanceConfiguration {</div><div class="c-code__line">        Constants.PerformanceProfiles profile;</div><div class="c-code__line">        <span class="c-code__keywordtype">boolean</span> allProperties;</div><div class="c-code__line">        <span class="c-code__keywordtype">boolean</span> performanceGraph;</div><div class="c-code__line">        <span class="c-code__keywordtype">boolean</span> predictiveGraph;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> PerformanceConfiguration(Constants.PerformanceProfiles profile,</div><div class="c-code__line">                                        <span class="c-code__keywordtype">boolean</span> allProperties, <span class="c-code__keywordtype">boolean</span> performanceGraph,</div><div class="c-code__line">                                        <span class="c-code__keywordtype">boolean</span> predictiveGraph) {</div><div class="c-code__line">            this.profile = profile;</div><div class="c-code__line">            this.allProperties = allProperties;</div><div class="c-code__line">            this.performanceGraph = performanceGraph;</div><div class="c-code__line">            this.predictiveGraph = predictiveGraph;</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line">}</div><div class="c-code__line"></div></div> </div><!-- primary -->
</div><!-- inner-->
<!-- HTML footer for doxygen 1.8.15-->
<!-- start footer part -->
<section id="nav-path" class="g-footer g-footer--docs"><!-- id is needed for treeview function! -->
    <p class="g-footer__copyright">Generated by
    <a href="http://www.doxygen.org/index.html">
    <b>doxygen</b></a> 1.8.15
  </p>
</section>
</div>
</main>
</div>
</body>
</html>
